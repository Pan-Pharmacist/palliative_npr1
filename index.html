<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palliative Care Smart System (Masterpiece)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * { font-family: 'Sarabun', sans-serif !important; }
        body { background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #1d4ed8; background-color: #eff6ff; }
        /* Table Sticky Header */
        .sticky-th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á</h1>
                <p class="text-slate-500 text-sm mt-1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏û‡∏£‡∏±‡∏ï‡∏ô‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg flex justify-center items-center gap-2">
                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <div id="loginLoader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                </button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow-md border-b border-slate-100 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col md:flex-row justify-between items-center py-3 gap-4">
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="bg-blue-50 p-2 rounded-lg">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-slate-800 leading-tight">Palliative Care</h1>
                            <p class="text-xs text-slate-500">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏û‡∏£‡∏±‡∏ï‡∏ô‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ</p>
                        </div>
                    </div>
                    <div class="flex-1 max-w-xl w-full relative">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></span>
                            <input type="text" id="smartSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm">
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                        <span id="userDisplay" class="text-sm font-medium text-slate-600 bg-slate-100 px-3 py-1 rounded-full border border-slate-200"></span>
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm font-semibold">‡∏≠‡∏≠‡∏Å</button>
                    </div>
                </div>
                
                <nav class="flex space-x-1 overflow-x-auto pt-2 pb-1 no-scrollbar">
                    <button onclick="switchTab('addPatient')" class="tab-btn active px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
                    <button onclick="switchTab('individual')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
                    <button onclick="switchTab('overall')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">3. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
                    <button onclick="switchTab('dashboard')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">4. Dashboard</button>
                    <button onclick="switchTab('editPatient')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">5. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="switchTab('report')" class="tab-btn px-4 py-2 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-t-lg whitespace-nowrap">6. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </nav>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
            
            <div id="tab-addPatient" class="tab-content fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-emerald-100 p-2 rounded-full">‚ûï</span> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
                    <form id="addPatientForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="label-text">HN *</label><input type="text" name="hn" class="input-box" required></div>
                            <div><label class="label-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label><input type="date" name="regDate" class="input-box" required></div>
                            <div><label class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label><input type="text" name="fname" class="input-box" required></div>
                            <div><label class="label-text">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" name="lname" class="input-box" required></div>
                            <div>
                                <label class="label-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</label>
                                <select name="status" class="input-box">
                                    <option value="Active">üü¢ Active</option>
                                    <option value="Palliative Only">üü° Palliative Only</option>
                                    <option value="End of Life">üü† End of Life</option>
                                    <option value="Deceased">‚ö´ Deceased</option>
                                    <option value="Discharged">‚ö™ Discharged</option>
                                </select>
                            </div>
                            <div><label class="label-text">‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏±‡∏Å (Diagnosis)</label><input type="text" name="diagnosis" class="input-box" required></div>
                            <div class="md:col-span-2"><label class="label-text">‡πÇ‡∏£‡∏Ñ‡∏£‡πà‡∏ß‡∏°</label><textarea name="comorbidities" rows="2" class="input-box"></textarea></div>
                        </div>
                        <div class="flex justify-end gap-3"><button type="reset" class="btn-secondary">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button><button type="submit" class="btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
                    </form>
                </div>
            </div>

            <div id="tab-individual" class="tab-content hidden fade-in">
                <div id="manualSearchSection" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div class="flex gap-4">
                        <input type="text" id="searchHNInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." class="flex-1 input-box">
                        <button onclick="searchPatient()" class="btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    <div class="mt-4 overflow-x-auto"><table class="w-full text-sm"><tbody id="patientListBody"></tbody></table></div>
                </div>

                <div id="patientDetailSection" class="hidden space-y-6">
                    <button onclick="backToSearch()" class="text-blue-600 hover:underline text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white border border-indigo-100 rounded-xl p-6 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-full -mr-4 -mt-4"></div>
                            <h3 class="text-2xl font-bold text-indigo-900 z-10 relative" id="detailName">...</h3>
                            <div class="mt-4 space-y-2 z-10 relative text-sm">
                                <p><span class="font-bold">HN:</span> <span id="detailHN" class="font-mono bg-slate-100 px-2 rounded"></span></p>
                                <p><span class="font-bold">Status:</span> <span id="detailStatus"></span></p>
                                <p><span class="font-bold">Dx:</span> <span id="detailDx"></span></p>
                            </div>
                            <button onclick="openVisitModal()" class="mt-6 w-full btn-primary">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Visit ‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                        <div class="lg:col-span-2 bg-white border border-slate-200 rounded-xl p-4 shadow-sm flex flex-col">
                            <h4 class="text-sm font-bold text-slate-600 mb-2">Pain Score Trend</h4>
                            <div class="flex-1 relative w-full h-48"><canvas id="painChart"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h4 class="text-lg font-bold text-slate-800 mb-4 pb-2 border-b">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm divide-y divide-slate-100">
                                <thead class="bg-slate-50"><tr><th class="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3 text-left">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/DRPs</th><th class="p-3 text-left">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</th><th class="p-3 text-center">Pain</th><th class="p-3 text-left">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th><th class="p-3 text-left">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th></tr></thead>
                                <tbody id="visitHistoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-overall" class="tab-content hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-slate-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Overall)</h2><button onclick="loadOverallData()" class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg text-sm">‚ü≥ Refresh</button></div>
                    <div class="overflow-x-auto max-h-[75vh]"><table class="w-full text-sm divide-y divide-slate-100"><thead class="bg-slate-50 sticky-th"><tr><th class="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3 text-left">HN</th><th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th><th class="p-3 text-left">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th><th class="p-3 text-center">Pain</th><th class="p-3 text-left">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th></tr></thead><tbody id="overallTableBody"></tbody></table></div>
                </div>
            </div>

            <div id="tab-dashboard" class="tab-content hidden fade-in">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-3xl font-bold text-blue-600" id="statTotalPatients">-</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-slate-500 text-sm">Visit ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p><p class="text-3xl font-bold text-emerald-600" id="statTotalVisits">-</p></div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-slate-500 text-sm">Pain Score > 7</p><p class="text-3xl font-bold text-red-600" id="statHighPain">-</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-96"><canvas id="dashboardChart"></canvas></div>
            </div>

            <div id="tab-editPatient" class="tab-content hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-amber-100 p-2 rounded-full">‚úèÔ∏è</span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                    <div class="flex gap-4 mb-6 pb-6 border-b">
                        <input type="text" id="editSearchHN" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ HN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..." class="input-box flex-1">
                        <button onclick="loadPatientForEdit()" class="btn-primary">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    <form id="editPatientForm" class="hidden space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="label-text">HN (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</label><input type="text" name="hn" id="edit_hn" class="input-box bg-slate-100" readonly></div>
                            <div><label class="label-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label><input type="date" name="regDate" id="edit_regDate" class="input-box" required></div>
                            <div><label class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label><input type="text" name="fname" id="edit_fname" class="input-box" required></div>
                            <div><label class="label-text">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" name="lname" id="edit_lname" class="input-box" required></div>
                            <div>
                                <label class="label-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                <select name="status" id="edit_status" class="input-box">
                                    <option value="Active">üü¢ Active</option>
                                    <option value="Palliative Only">üü° Palliative Only</option>
                                    <option value="End of Life">üü† End of Life</option>
                                    <option value="Deceased">‚ö´ Deceased</option>
                                    <option value="Discharged">‚ö™ Discharged</option>
                                </select>
                            </div>
                            <div><label class="label-text">Diagnosis</label><input type="text" name="diagnosis" id="edit_diagnosis" class="input-box" required></div>
                            <div class="md:col-span-2"><label class="label-text">‡πÇ‡∏£‡∏Ñ‡∏£‡πà‡∏ß‡∏°</label><textarea name="comorbidities" id="edit_comorbidities" rows="2" class="input-box"></textarea></div>
                        </div>
                        <div class="flex justify-end gap-3"><button type="submit" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>
                    </form>
                </div>
            </div>

            <div id="tab-report" class="tab-content hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 max-w-4xl mx-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-indigo-100 p-2 rounded-full">üìÑ</span> ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Export)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="label-text">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rptStart" class="input-box"></div>
                        <div><label class="label-text">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rptEnd" class="input-box"></div>
                    </div>
                    <div class="flex gap-3 justify-center">
                        <button onclick="exportReport('excel')" class="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 shadow font-bold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Download Excel
                        </button>
                        <button onclick="exportReport('word')" class="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 shadow font-bold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Download Word
                        </button>
                    </div>
                    <p class="text-center text-slate-400 text-sm mt-4">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: HN, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥, ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤, DRPs, ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                </div>
            </div>

        </main>
    </div>

    <div id="visitModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden items-center justify-center z-[60] backdrop-blur-sm px-4">
        <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="border-b p-5 flex justify-between items-center bg-slate-50 sticky top-0 z-20">
                <h3 class="text-xl font-bold text-slate-800">üè• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Visit Note (Comprehensive)</h3>
                <button onclick="closeVisitModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="visitForm" class="space-y-6">
                    <input type="hidden" id="visitHnHidden">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg border">
                        <div><label class="label-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="visitDate" class="input-box" required></div>
                        <div><label class="label-text">‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏• (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" id="visitDuration" class="input-box" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30"></div>
                        <div class="md:col-span-2">
                            <label class="label-text text-red-600">Pain Score (0-10)</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="visitPainScore" min="0" max="10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('painVal').innerText=this.value">
                                <span id="painVal" class="text-xl font-bold text-red-600 w-8">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="label-text">1. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</label><textarea id="visitHistory" rows="3" class="input-box"></textarea></div>
                        <div><label class="label-text">2. ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ / ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö</label><textarea id="visitRegimen" rows="3" class="input-box"></textarea></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div><label class="label-text">3. ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (DRPs) / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label><textarea id="visitDrp" rows="3" class="input-box bg-orange-50 border-orange-200"></textarea></div>
                         <div><label class="label-text">4. ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô / ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</label><textarea id="visitIntervention" rows="3" class="input-box bg-green-50 border-green-200"></textarea></div>
                    </div>
                    <div><label class="label-text">5. ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Outcome)</label><input type="text" id="visitOutcome" class="input-box"></div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-3">üå°Ô∏è ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÅ‡∏•‡∏õ (Vital Signs & Labs)</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div><label>BP (mmHg)</label><input type="text" id="v_bp" class="input-box h-8 text-sm"></div>
                            <div><label>Pulse (bpm)</label><input type="number" id="v_pulse" class="input-box h-8 text-sm"></div>
                            <div><label>O2 Sat (%)</label><input type="number" id="v_o2" class="input-box h-8 text-sm"></div>
                            <div><label>BW (kg)</label><input type="number" id="v_weight" class="input-box h-8 text-sm" onchange="calcBMI()"></div>
                            <div><label>Height (cm)</label><input type="number" id="v_height" class="input-box h-8 text-sm" onchange="calcBMI()"></div>
                            <div><label>BMI</label><input type="text" id="v_bmi" class="input-box h-8 text-sm bg-slate-200" readonly></div>
                            <div><label>eGFR</label><input type="number" id="l_egfr" class="input-box h-8 text-sm"></div>
                            <div><label>Creatinine</label><input type="number" id="l_cr" class="input-box h-8 text-sm"></div>
                            <div><label>Total Protein</label><input type="number" id="l_prot" class="input-box h-8 text-sm"></div>
                            <div><label>Albumin</label><input type="number" id="l_alb" class="input-box h-8 text-sm"></div>
                            <div><label>AST</label><input type="number" id="l_ast" class="input-box h-8 text-sm"></div>
                            <div><label>ALT</label><input type="number" id="l_alt" class="input-box h-8 text-sm"></div>
                        </div>
                        <div class="mt-3"><label class="text-xs">Lab ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label><input type="text" id="l_other" class="input-box h-8 text-sm"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="label-text">üìé ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡∏õ/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</label>
                            <input type="file" id="visitFile" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div><label class="label-text">Note (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</label><input type="text" id="visitNotes" class="input-box"></div>
                    </div>
                </form>
            </div>
            <div class="p-5 bg-slate-50 border-t flex justify-end gap-3 sticky bottom-0 z-20">
                <button onclick="closeVisitModal()" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveVisit()" class="btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Visit</button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbzTTmE1nSV_G1y3baMMQAwAt038Aw25gIBoqBaxWkhmfTpd7ylV6FAPYLZTTTcX_isl/exec'; // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

        // Global Styles
        const style = document.createElement('style');
        style.textContent = `
            .input-box { width:100%; padding:0.5rem 1rem; border:1px solid #e2e8f0; border-radius:0.5rem; outline:none; transition:all 0.2s; }
            .input-box:focus { border-color:#3b82f6; ring:2px; ring-color:#bfdbfe; }
            .label-text { display:block; font-size:0.875rem; font-weight:600; color:#334155; margin-bottom:0.25rem; }
            .btn-primary { background-color:#2563eb; color:white; padding:0.5rem 1.5rem; border-radius:0.5rem; font-weight:600; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); transition:all 0.2s; }
            .btn-primary:hover { background-color:#1d4ed8; }
            .btn-secondary { background-color:white; border:1px solid #cbd5e1; color:#475569; padding:0.5rem 1.5rem; border-radius:0.5rem; transition:all 0.2s; }
            .btn-secondary:hover { background-color:#f8fafc; }
        `;
        document.head.appendChild(style);

        let currentUser = null;
        let currentPatient = null;
        let allPatients = [];
        let painChartInstance = null;
        let dashChartInstance = null;

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('loginLoader');
            btn.disabled = true; loader.classList.remove('hidden');

            try {
                const res = await fetchAPI('login', { username: document.getElementById('username').value, password: document.getElementById('password').value });
                if (res.success) {
                    currentUser = res.user;
                    document.getElementById('userDisplay').innerText = `üë§ ${currentUser.name}`;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadAllPatients();
                    switchTab('dashboard'); // Default to Dashboard for Overview
                } else {
                    Swal.fire('Login Failed', res.message, 'error');
                }
            } catch (err) { Swal.fire('Error', 'Connection Error', 'error'); } 
            finally { btn.disabled = false; loader.classList.add('hidden'); }
        });

        function logout() { location.reload(); }

        async function fetchAPI(action, data = {}) {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
            return await response.json();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            const btns = document.querySelectorAll('.tab-btn');
            const mapping = { 'addPatient':0, 'individual':1, 'overall':2, 'dashboard':3, 'editPatient':4, 'report':5 };
            if(mapping[tabId] !== undefined) btns[mapping[tabId]].classList.add('active');

            if(tabId === 'overall') loadOverallData();
            if(tabId === 'dashboard') loadDashboard();
        }

        // --- PATIENT MANAGEMENT ---
        document.getElementById('addPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            Swal.showLoading();
            const formData = new FormData(e.target);
            const res = await fetchAPI('addPatient', Object.fromEntries(formData));
            if (res.success) { Swal.fire('Success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); e.target.reset(); loadAllPatients(); }
            else Swal.fire('Error', res.message, 'error');
        });

        async function loadAllPatients() {
            const res = await fetchAPI('getPatients');
            if(res.success) { allPatients = res.data; renderPatientList(allPatients); }
        }

        function renderPatientList(list) {
            const tbody = document.getElementById('patientListBody');
            tbody.innerHTML = list.length ? '' : '<tr><td colspan="4" class="p-4 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            list.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 cursor-pointer border-b';
                tr.onclick = () => { switchTab('individual'); selectPatient(p); };
                tr.innerHTML = `<td class="p-3 font-bold text-indigo-600">${p.hn}</td><td class="p-3">${p.fname} ${p.lname}</td><td class="p-3 text-slate-500">${p.diagnosis}</td><td class="p-3"><span class="badge badge-sm">${p.status}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        function searchPatient() {
            const q = document.getElementById('searchHNInput').value.toLowerCase();
            renderPatientList(allPatients.filter(p => p.hn.includes(q) || p.fname.toLowerCase().includes(q) || (p.fname+' '+p.lname).toLowerCase().includes(q)));
        }

        document.getElementById('smartSearch').addEventListener('keyup', (e) => {
            if(e.key === 'Enter') {
                const found = allPatients.find(p => p.hn === e.target.value || p.fname.includes(e.target.value));
                if(found) { switchTab('individual'); selectPatient(found); e.target.value=''; }
                else Swal.fire({toast:true, title:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', icon:'warning'});
            }
        });

        async function selectPatient(p) {
            currentPatient = p;
            document.getElementById('manualSearchSection').classList.add('hidden');
            document.getElementById('patientDetailSection').classList.remove('hidden');
            document.getElementById('detailName').innerText = `${p.fname} ${p.lname}`;
            document.getElementById('detailHN').innerText = p.hn;
            document.getElementById('detailStatus').innerText = p.status;
            document.getElementById('detailDx').innerText = p.diagnosis;

            const res = await fetchAPI('getVisits', { hn: p.hn });
            const tbody = document.getElementById('visitHistoryBody');
            tbody.innerHTML = '';
            if(res.success && res.data.length) {
                res.data.forEach(v => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 border-b">
                            <td class="p-3 whitespace-nowrap">${v.date}</td>
                            <td class="p-3 max-w-xs truncate" title="${v.history}\nDRP: ${v.drp}">${v.history}</td>
                            <td class="p-3 max-w-xs truncate" title="${v.regimen}">${v.regimen}</td>
                            <td class="p-3 text-center font-bold ${v.painScore>=7?'text-red-600':'text-slate-600'}">${v.painScore}</td>
                            <td class="p-3 text-center">${v.fileUrl ? `<a href="${v.fileUrl}" target="_blank" class="text-blue-500">üìé</a>` : '-'}</td>
                            <td class="p-3 text-xs text-slate-500">${v.recorder}</td>
                        </tr>`;
                });
                renderChart(res.data);
            } else { tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>'; renderChart([]); }
        }

        function backToSearch() {
            document.getElementById('patientDetailSection').classList.add('hidden');
            document.getElementById('manualSearchSection').classList.remove('hidden');
        }

        function renderChart(visits) {
            const ctx = document.getElementById('painChart').getContext('2d');
            if(painChartInstance) painChartInstance.destroy();
            const sorted = [...visits].reverse();
            painChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(v => v.date.substring(5)),
                    datasets: [{ label: 'Pain Score', data: sorted.map(v => v.painScore), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10 } } }
            });
        }

        // --- VISIT LOGIC ---
        function openVisitModal() {
            document.getElementById('visitForm').reset();
            document.getElementById('visitHnHidden').value = currentPatient.hn;
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('visitPainScore').value = 0; document.getElementById('painVal').innerText = '0';
            document.getElementById('visitModal').classList.remove('hidden');
            document.getElementById('visitModal').classList.add('flex');
        }
        function closeVisitModal() { document.getElementById('visitModal').classList.add('hidden'); document.getElementById('visitModal').classList.remove('flex'); }

        function calcBMI() {
            const w = parseFloat(document.getElementById('v_weight').value);
            const h = parseFloat(document.getElementById('v_height').value);
            if(w && h) {
                const bmi = w / ((h/100) ** 2);
                document.getElementById('v_bmi').value = bmi.toFixed(2);
            }
        }

        async function saveVisit() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            // File Handling
            const fileInput = document.getElementById('visitFile');
            let fileData = null, fileName = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if(file.size > 4000000) { Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 4MB', 'error'); return; } // Limit for stability
                fileName = file.name;
                fileData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const payload = {
                hn: document.getElementById('visitHnHidden').value,
                date: document.getElementById('visitDate').value,
                painScore: document.getElementById('visitPainScore').value,
                history: document.getElementById('visitHistory').value,
                regimen: document.getElementById('visitRegimen').value,
                drp: document.getElementById('visitDrp').value,
                intervention: document.getElementById('visitIntervention').value,
                outcome: document.getElementById('visitOutcome').value,
                duration: document.getElementById('visitDuration').value,
                // Vitals
                bp: document.getElementById('v_bp').value, pulse: document.getElementById('v_pulse').value, o2: document.getElementById('v_o2').value,
                weight: document.getElementById('v_weight').value, height: document.getElementById('v_height').value, bmi: document.getElementById('v_bmi').value,
                // Labs
                egfr: document.getElementById('l_egfr').value, creatinine: document.getElementById('l_cr').value, protein: document.getElementById('l_prot').value,
                albumin: document.getElementById('l_alb').value, ast: document.getElementById('l_ast').value, alt: document.getElementById('l_alt').value, otherLabs: document.getElementById('l_other').value,
                // Misc
                notes: document.getElementById('visitNotes').value,
                recorder: currentUser.name,
                fileData: fileData,
                fileName: fileName
            };

            const res = await fetchAPI('addVisit', payload);
            if(res.success) {
                Swal.fire('Saved', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeVisitModal();
                selectPatient(currentPatient);
            } else { Swal.fire('Error', res.message, 'error'); }
        }

        // --- OVERALL ---
        async function loadOverallData() {
            const tbody = document.getElementById('overallTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>';
            const res = await fetchAPI('getAllVisits');
            tbody.innerHTML = '';
            res.data.slice(0, 100).forEach(v => {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-3 whitespace-nowrap">${v.date}</td>
                        <td class="p-3 text-slate-500">${v.hn}</td>
                        <td class="p-3 font-medium text-blue-600 cursor-pointer" onclick="jumpToPatient('${v.hn}')">${v.patientName}</td>
                        <td class="p-3 text-slate-600 truncate max-w-xs">${v.history}</td>
                        <td class="p-3 text-center font-bold ${v.painScore>=7?'text-red-600':'text-slate-400'}">${v.painScore}</td>
                        <td class="p-3 text-slate-400 text-xs">${v.recorder}</td>
                    </tr>`;
            });
            window.allVisitsData = res.data; // Cache for dashboard
        }
        function jumpToPatient(hn) { const p = allPatients.find(x => x.hn===hn); if(p) { switchTab('individual'); selectPatient(p); } }

        // --- EDIT PATIENT ---
        function loadPatientForEdit() {
            const hn = document.getElementById('editSearchHN').value.trim();
            const p = allPatients.find(x => x.hn === hn);
            if(p) {
                document.getElementById('editPatientForm').classList.remove('hidden');
                document.getElementById('edit_hn').value = p.hn;
                document.getElementById('edit_regDate').value = p.regDate; // Check format YYYY-MM-DD
                document.getElementById('edit_fname').value = p.fname;
                document.getElementById('edit_lname').value = p.lname;
                document.getElementById('edit_status').value = p.status;
                document.getElementById('edit_diagnosis').value = p.diagnosis;
                document.getElementById('edit_comorbidities').value = p.comorbidities;
            } else { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö HN', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç HN', 'error'); }
        }

        document.getElementById('editPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            Swal.showLoading();
            const data = Object.fromEntries(new FormData(e.target));
            const res = await fetchAPI('updatePatient', data);
            if(res.success) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadAllPatients(); }
            else Swal.fire('Error', res.message, 'error');
        });

        // --- DASHBOARD ---
        function loadDashboard() {
            document.getElementById('statTotalPatients').innerText = allPatients.length;
            const resData = window.allVisitsData || [];
            document.getElementById('statTotalVisits').innerText = resData.filter(v => new Date(v.date).getMonth() === new Date().getMonth()).length;
            document.getElementById('statHighPain').innerText = resData.filter(v => v.painScore >= 7).length;

            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if(dashChartInstance) dashChartInstance.destroy();
            dashChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.'], // Demo labels
                    datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•', data: [12, 19, 3, 5, 2, 3], backgroundColor: '#3b82f6' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- REPORTS (Export) ---
        async function exportReport(type) {
            const start = document.getElementById('rptStart').value;
            const end = document.getElementById('rptEnd').value;
            if(!start || !end) return Swal.fire('Warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'warning');

            Swal.showLoading();
            const res = await fetchAPI('getReportData', { startDate: start, endDate: end });
            
            if(!res.success || res.data.length === 0) return Swal.fire('Info', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ', 'info');

            if(type === 'excel') {
                const ws = XLSX.utils.json_to_sheet(res.data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, `Report_${start}_to_${end}.xlsx`);
            } else if(type === 'word') {
                let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Report</title></head><body>`;
                html += `<h1 style="text-align:center">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏ö‡∏≤‡∏•‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏° (Palliative Care)</h1>`;
                html += `<p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${start} ‡∏ñ‡∏∂‡∏á ${end}</p>`;
                html += `<table border="1" style="border-collapse:collapse; width:100%"><thead><tr style="background:#ddd"><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>HN</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th><th>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö</th><th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (DRPs)/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th><th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th></tr></thead><tbody>`;
                
                res.data.forEach(d => {
                    html += `<tr>
                        <td>${d.date}</td><td>${d.hn}</td><td>${d.name}</td>
                        <td>${d.history}</td><td>${d.regimen}</td><td>${d.drp}<br/>Advice: ${d.intervention}</td><td>${d.outcome}</td>
                    </tr>`;
                });
                html += `</tbody></table></body></html>`;
                
                const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Report_${start}_to_${end}.doc`;
                a.click();
            }
            Swal.close();
        }
    </script>
</body>
</html>
